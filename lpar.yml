---
  - name: Configure Node
    hosts: hmc
    serial: 1
    gather_facts: no
    remote_user: hscroot
    collections:
      - ibm.spectrum_virtualize
      - ibm.power_hmc
      - brocade.fos
    vars:
#      - hmc_host: dsshmc
      - hmc_user: hscroot
      - hmc_password: S0ccerBabe!
      - system: Server-8286-41A-SN78E9E9W
      - vm_name: test_vm

    tasks:
    - name: Create an AIX/Linux logical partition instance 
      powervm_lpar_instance:
        hmc_host: "{{ inventory_hostname }}"
        hmc_auth:
          username: '{{ hmc_user }}'
          password: '{{ hmc_password }}'
        system_name: '{{ system }}'
        vm_name: '{{ vm_name }}'
        proc_unit: 0.1
        proc: 1
        min_mem: 256
        mem: 512
        npiv_config:
         - vios_name: vios1
           fc_port: fcs0
         - vios_name: vios1
           fc_port: fcs1
        os_type: aix_linux
        state: present
      delegate_to: localhost

    - name: Get list of installed WWPN's
      hmc_command:
        hmc_host: "{{ inventory_hostname }}"
        hmc_auth:
          username: '{{ hmc_user }}'
          password: '{{ hmc_password }}'
#        cmd: lshwres -r virtualio --rsubtype fc -m {{ system }} --level lpar -F lpar_name,slot_num,wwpns --filter "lpar_names={{ vm_name }}"
        cmd: lshwres -r virtualio --rsubtype fc -m {{ system }} --level lpar --filter "lpar_names={{ vm_name }}"
      register: wwpns
      delegate_to: localhost

    - name: show wwpns
      debug:
        var: wwpns

    - name: get detail
      set_fact:
        npiv: "{{ item.split(',') | regex_replace('\"','') }}"
      loop: "{{ wwpns.command_output }}"
      register: fc_details

    - name: show npiv
      debug:
        var: fc_details

#    - name: get NPIV info
#      powervm_lpar_instance:
#        hmc_host: "{{ inventory_hostname }}"
#        hmc_auth:
#          username: '{{ hmc_user }}'
#          password: '{{ hmc_password }}'
#        system_name: '{{ system }}'
#        vm_name: "test_vm"
#        state: present
#        os_type: aix
#      delegate_to: localhost
#      register: npiv
#
#    - name: show NPIV
#      debug:
#        var: npiv
